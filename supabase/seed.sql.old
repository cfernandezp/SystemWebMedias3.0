-- ============================================
-- Supabase Seed File - SystemWebMedias 3.0
-- Data de prueba persistente para desarrollo local
-- Se ejecuta automáticamente después de cada 'npx supabase db reset'
-- ============================================

-- ============================================
-- CREDENCIALES DE ACCESO
-- ============================================
-- ADMIN:     admin@test.com    / asdasd211
-- GERENTE:   gerente@test.com  / asdasd211
-- VENDEDOR:  vendedor@test.com / asdasd211
-- ============================================

BEGIN;

-- ============================================
-- 1. CREAR TIENDAS
-- ============================================

INSERT INTO tiendas (id, nombre, direccion, meta_mensual, activa) VALUES
('11111111-1111-1111-1111-111111111111', 'Tienda Centro', 'Av. Principal 123', 50000.00, true),
('22222222-2222-2222-2222-222222222222', 'Tienda Norte', 'Calle Comercio 456', 40000.00, true),
('33333333-3333-3333-3333-333333333333', 'Tienda Sur', 'Blvd. Sur 789', 35000.00, true);

-- ============================================
-- 2. CREAR PRODUCTOS (30 productos con stock variado)
-- ============================================

INSERT INTO productos (nombre, descripcion, precio, stock_actual, stock_maximo, activo) VALUES
-- Stock normal
('Medias Deportivas Negras', 'Medias deportivas de algodón', 15.99, 50, 100, true),
('Medias Ejecutivas Grises', 'Medias formales para oficina', 12.50, 80, 100, true),
('Medias Casuales Blancas', 'Medias casuales de uso diario', 10.00, 60, 100, true),
('Medias Térmicas Azules', 'Medias térmicas para invierno', 18.99, 45, 100, true),
('Medias Running Rojas', 'Medias especiales para running', 20.00, 35, 100, true),
('Medias Bambú Verdes', 'Medias ecológicas de bambú', 22.00, 40, 100, true),
('Medias Compresión Negras', 'Medias de compresión deportiva', 25.00, 30, 100, true),
('Medias Invisibles Beige', 'Medias invisibles para zapatos', 8.50, 70, 100, true),
('Medias Largas Grises', 'Medias largas hasta rodilla', 16.00, 55, 100, true),
('Medias Cortas Blancas', 'Medias cortas deportivas', 9.99, 65, 100, true),

-- Stock bajo (< 20% = < 20 unidades)
('Medias Algodón Azules', 'Medias de algodón puro', 14.00, 18, 100, true),
('Medias Lana Grises', 'Medias de lana para invierno', 19.00, 15, 100, true),
('Medias Seda Negras', 'Medias de seda premium', 30.00, 12, 100, true),
('Medias Antiolor Blancas', 'Medias con tecnología antiolor', 17.00, 10, 100, true),
('Medias Reforzadas Grises', 'Medias con talón reforzado', 16.50, 8, 100, true),

-- Stock crítico (< 5 unidades)
('Medias Coolmax Azules', 'Medias con tecnología Coolmax', 23.00, 4, 100, true),
('Medias Merino Rojas', 'Medias de lana merino', 28.00, 3, 100, true),
('Medias Premium Negras', 'Medias premium importadas', 35.00, 2, 100, true),
('Medias Antibacterial Verde', 'Medias antibacteriales', 21.00, 1, 100, true),

-- Productos adicionales con stock normal
('Medias Rayas Multicolor', 'Medias con diseño de rayas', 11.00, 50, 100, true),
('Medias Lunares Rojas', 'Medias con lunares', 12.00, 45, 100, true),
('Medias Lisa Beige', 'Medias lisas color beige', 10.50, 55, 100, true),
('Medias Deporte Pro Negras', 'Medias profesionales deporte', 24.00, 40, 100, true),
('Medias Casual Premium Grises', 'Medias casuales premium', 18.00, 35, 100, true),
('Medias Ejecutivo Azul', 'Medias ejecutivas azul marino', 15.00, 48, 100, true),
('Medias Comfort Blancas', 'Medias extra comfort', 13.50, 52, 100, true),
('Medias Running Pro Rojas', 'Medias running profesionales', 26.00, 28, 100, true),
('Medias Trekking Verdes', 'Medias para trekking', 22.50, 25, 100, true),
('Medias Ciclismo Negras', 'Medias especiales ciclismo', 27.00, 20, 100, true),
('Medias Yoga Multicolor', 'Medias para yoga y pilates', 16.50, 42, 100, true);

-- ============================================
-- 3. CREAR CLIENTES (50 clientes)
-- ============================================

INSERT INTO clientes (nombre_completo, email, telefono, activo) VALUES
('Carlos Ramírez', 'carlos.ramirez@example.com', '555-0101', true),
('Ana López', 'ana.lopez@example.com', '555-0102', true),
('Miguel González', 'miguel.gonzalez@example.com', '555-0103', true),
('Laura Martínez', 'laura.martinez@example.com', '555-0104', true),
('Pedro Sánchez', 'pedro.sanchez@example.com', '555-0105', true),
('María Rodríguez', 'maria.rodriguez@example.com', '555-0106', true),
('Juan Pérez', 'juan.perez@example.com', '555-0107', true),
('Carmen Fernández', 'carmen.fernandez@example.com', '555-0108', true),
('Roberto Díaz', 'roberto.diaz@example.com', '555-0109', true),
('Isabel Torres', 'isabel.torres@example.com', '555-0110', true),
('Francisco Ruiz', 'francisco.ruiz@example.com', '555-0111', true),
('Sofía Moreno', 'sofia.moreno@example.com', '555-0112', true),
('Antonio Jiménez', 'antonio.jimenez@example.com', '555-0113', true),
('Elena Álvarez', 'elena.alvarez@example.com', '555-0114', true),
('Jorge Romero', 'jorge.romero@example.com', '555-0115', true),
('Patricia Navarro', 'patricia.navarro@example.com', '555-0116', true),
('Luis Herrera', 'luis.herrera@example.com', '555-0117', true),
('Marta Castro', 'marta.castro@example.com', '555-0118', true),
('Daniel Vargas', 'daniel.vargas@example.com', '555-0119', true),
('Cristina Ortiz', 'cristina.ortiz@example.com', '555-0120', true),
('Javier Ramírez', 'javier.ramirez@example.com', '555-0121', true),
('Andrea Morales', 'andrea.morales@example.com', '555-0122', true),
('Fernando Gil', 'fernando.gil@example.com', '555-0123', true),
('Beatriz Mendoza', 'beatriz.mendoza@example.com', '555-0124', true),
('Manuel Silva', 'manuel.silva@example.com', '555-0125', true),
('Rosa Guerrero', 'rosa.guerrero@example.com', '555-0126', true),
('Alberto Santos', 'alberto.santos@example.com', '555-0127', true),
('Lucía Vega', 'lucia.vega@example.com', '555-0128', true),
('Raúl Medina', 'raul.medina@example.com', '555-0129', true),
('Teresa Cruz', 'teresa.cruz@example.com', '555-0130', true),
('Sergio Ramos', 'sergio.ramos@example.com', '555-0131', true),
('Pilar Ibáñez', 'pilar.ibanez@example.com', '555-0132', true),
('Enrique Peña', 'enrique.pena@example.com', '555-0133', true),
('Silvia Cortés', 'silvia.cortes@example.com', '555-0134', true),
('Óscar Delgado', 'oscar.delgado@example.com', '555-0135', true),
('Natalia Campos', 'natalia.campos@example.com', '555-0136', true),
('Ricardo Ortega', 'ricardo.ortega@example.com', '555-0137', true),
('Mónica Suárez', 'monica.suarez@example.com', '555-0138', true),
('Pablo Márquez', 'pablo.marquez@example.com', '555-0139', true),
('Verónica Rojas', 'veronica.rojas@example.com', '555-0140', true),
('Andrés Molina', 'andres.molina@example.com', '555-0141', true),
('Irene Castro', 'irene.castro@example.com', '555-0142', true),
('David Flores', 'david.flores@example.com', '555-0143', true),
('Alicia Prieto', 'alicia.prieto@example.com', '555-0144', true),
('Raquel Garrido', 'raquel.garrido@example.com', '555-0145', true),
('Víctor Pascual', 'victor.pascual@example.com', '555-0146', true),
('Sandra León', 'sandra.leon@example.com', '555-0147', true),
('Hugo Serrano', 'hugo.serrano@example.com', '555-0148', true),
('Eva Blanco', 'eva.blanco@example.com', '555-0149', true),
('Iván Rubio', 'ivan.rubio@example.com', '555-0150', true);

COMMIT;

-- ============================================
-- 4. CREAR USUARIOS DE AUTENTICACIÓN
-- ============================================
-- NOTA: Esta sección crea usuarios directamente en auth.users y auth.identities
-- Solo funciona en desarrollo local con Supabase local

DO $$
DECLARE
    -- UUIDs fijos para usuarios de prueba (facilita referencias)
    v_admin_id UUID := 'aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa';
    v_gerente_id UUID := 'bbbbbbbb-bbbb-bbbb-bbbb-bbbbbbbbbbbb';
    v_vendedor_id UUID := 'cccccccc-cccc-cccc-cccc-cccccccccccc';

    v_encrypted_pass TEXT;
BEGIN
    -- Generar contraseña encriptada para 'asdasd211' usando bcrypt
    v_encrypted_pass := crypt('asdasd211', gen_salt('bf'));

    -- ========================================
    -- 1. USUARIO ADMIN
    -- ========================================
    IF NOT EXISTS (SELECT 1 FROM auth.users WHERE id = v_admin_id) THEN
        INSERT INTO auth.users (
            id,
            instance_id,
            email,
            encrypted_password,
            email_confirmed_at,
            raw_user_meta_data,
            raw_app_meta_data,
            created_at,
            updated_at,
            aud,
            role
        ) VALUES (
            v_admin_id,
            '00000000-0000-0000-0000-000000000000',
            'admin@test.com',
            v_encrypted_pass,
            NOW(),
            jsonb_build_object(
                'rol', 'ADMIN',
                'nombre_completo', 'Administrador Principal',
                'email', 'admin@test.com'
            ),
            jsonb_build_object(
                'provider', 'email',
                'providers', ARRAY['email']
            ),
            NOW(),
            NOW(),
            'authenticated',
            'authenticated'
        );

        RAISE NOTICE 'Usuario ADMIN creado: admin@test.com';
    END IF;

    -- ========================================
    -- 2. USUARIO GERENTE
    -- ========================================
    IF NOT EXISTS (SELECT 1 FROM auth.users WHERE id = v_gerente_id) THEN
        INSERT INTO auth.users (
            id,
            instance_id,
            email,
            encrypted_password,
            email_confirmed_at,
            raw_user_meta_data,
            raw_app_meta_data,
            created_at,
            updated_at,
            aud,
            role
        ) VALUES (
            v_gerente_id,
            '00000000-0000-0000-0000-000000000000',
            'gerente@test.com',
            v_encrypted_pass,
            NOW(),
            jsonb_build_object(
                'rol', 'GERENTE',
                'nombre_completo', 'Gerente Tienda Centro',
                'email', 'gerente@test.com',
                'tienda_id', '11111111-1111-1111-1111-111111111111'
            ),
            jsonb_build_object(
                'provider', 'email',
                'providers', ARRAY['email']
            ),
            NOW(),
            NOW(),
            'authenticated',
            'authenticated'
        );

        RAISE NOTICE 'Usuario GERENTE creado: gerente@test.com';
    END IF;

    -- ========================================
    -- 3. USUARIO VENDEDOR
    -- ========================================
    IF NOT EXISTS (SELECT 1 FROM auth.users WHERE id = v_vendedor_id) THEN
        INSERT INTO auth.users (
            id,
            instance_id,
            email,
            encrypted_password,
            email_confirmed_at,
            raw_user_meta_data,
            raw_app_meta_data,
            created_at,
            updated_at,
            aud,
            role
        ) VALUES (
            v_vendedor_id,
            '00000000-0000-0000-0000-000000000000',
            'vendedor@test.com',
            v_encrypted_pass,
            NOW(),
            jsonb_build_object(
                'rol', 'VENDEDOR',
                'nombre_completo', 'Vendedor Tienda Centro',
                'email', 'vendedor@test.com',
                'tienda_id', '11111111-1111-1111-1111-111111111111'
            ),
            jsonb_build_object(
                'provider', 'email',
                'providers', ARRAY['email']
            ),
            NOW(),
            NOW(),
            'authenticated',
            'authenticated'
        );

        RAISE NOTICE 'Usuario VENDEDOR creado: vendedor@test.com';
    END IF;

    -- ========================================
    -- CREAR IDENTIDADES PARA LOGIN
    -- ========================================

    -- Identity para ADMIN
    IF NOT EXISTS (SELECT 1 FROM auth.identities WHERE provider_id = v_admin_id::text AND provider = 'email') THEN
        INSERT INTO auth.identities (
            provider_id,
            user_id,
            identity_data,
            provider,
            last_sign_in_at,
            created_at,
            updated_at
        ) VALUES (
            v_admin_id::text,
            v_admin_id,
            jsonb_build_object(
                'sub', v_admin_id::text,
                'email', 'admin@test.com',
                'email_verified', true,
                'phone_verified', false
            ),
            'email',
            NOW(),
            NOW(),
            NOW()
        );
    END IF;

    -- Identity para GERENTE
    IF NOT EXISTS (SELECT 1 FROM auth.identities WHERE provider_id = v_gerente_id::text AND provider = 'email') THEN
        INSERT INTO auth.identities (
            provider_id,
            user_id,
            identity_data,
            provider,
            last_sign_in_at,
            created_at,
            updated_at
        ) VALUES (
            v_gerente_id::text,
            v_gerente_id,
            jsonb_build_object(
                'sub', v_gerente_id::text,
                'email', 'gerente@test.com',
                'email_verified', true,
                'phone_verified', false
            ),
            'email',
            NOW(),
            NOW(),
            NOW()
        );
    END IF;

    -- Identity para VENDEDOR
    IF NOT EXISTS (SELECT 1 FROM auth.identities WHERE provider_id = v_vendedor_id::text AND provider = 'email') THEN
        INSERT INTO auth.identities (
            provider_id,
            user_id,
            identity_data,
            provider,
            last_sign_in_at,
            created_at,
            updated_at
        ) VALUES (
            v_vendedor_id::text,
            v_vendedor_id,
            jsonb_build_object(
                'sub', v_vendedor_id::text,
                'email', 'vendedor@test.com',
                'email_verified', true,
                'phone_verified', false
            ),
            'email',
            NOW(),
            NOW(),
            NOW()
        );
    END IF;

    RAISE NOTICE '========================================';
    RAISE NOTICE 'Usuarios de autenticación creados exitosamente';
    RAISE NOTICE '========================================';

END $$;

-- ============================================
-- 5. ASIGNAR TIENDAS A USUARIOS
-- ============================================

BEGIN;

INSERT INTO user_tiendas (user_id, tienda_id, activo) VALUES
-- Gerente → Tienda Centro
('bbbbbbbb-bbbb-bbbb-bbbb-bbbbbbbbbbbb', '11111111-1111-1111-1111-111111111111', true),
-- Vendedor → Tienda Centro
('cccccccc-cccc-cccc-cccc-cccccccccccc', '11111111-1111-1111-1111-111111111111', true)
ON CONFLICT (user_id, tienda_id) DO NOTHING;

COMMIT;

-- ============================================
-- 6. CREAR VENTAS (200 ventas últimos 6 meses)
-- ============================================

DO $$
DECLARE
    v_tienda_ids UUID[] := ARRAY[
        '11111111-1111-1111-1111-111111111111',
        '22222222-2222-2222-2222-222222222222',
        '33333333-3333-3333-3333-333333333333'
    ];
    v_vendedor_id UUID := 'cccccccc-cccc-cccc-cccc-cccccccccccc'; -- El vendedor creado
    v_cliente_ids UUID[];
    v_producto_ids UUID[];
    v_venta_id UUID;
    v_fecha TIMESTAMP WITH TIME ZONE;
    v_monto DECIMAL(12, 2);
    v_estado venta_estado;
    v_tienda_id UUID;
    v_cliente_id UUID;
    v_num_items INTEGER;
    v_producto_id UUID;
    v_cantidad INTEGER;
    v_precio DECIMAL(10, 2);
    v_subtotal DECIMAL(12, 2);
    i INTEGER;
    j INTEGER;
BEGIN
    -- Obtener arrays de clientes y productos
    SELECT ARRAY_AGG(id) INTO v_cliente_ids FROM clientes WHERE activo = true;
    SELECT ARRAY_AGG(id) INTO v_producto_ids FROM productos WHERE activo = true;

    -- Crear 200 ventas distribuidas en 6 meses
    FOR i IN 1..200 LOOP
        -- Generar UUID para la venta
        v_venta_id := gen_random_uuid();

        -- Fecha aleatoria en los últimos 6 meses
        v_fecha := NOW() - (RANDOM() * 180)::INTEGER * INTERVAL '1 day';

        -- Estado aleatorio (80% completadas, 15% en proceso, 5% pendientes)
        CASE
            WHEN RANDOM() < 0.80 THEN v_estado := 'COMPLETADA';
            WHEN RANDOM() < 0.95 THEN v_estado := 'EN_PROCESO';
            ELSE v_estado := 'PENDIENTE';
        END CASE;

        -- Seleccionar tienda aleatoria
        v_tienda_id := v_tienda_ids[1 + FLOOR(RANDOM() * 3)::INTEGER];

        -- Seleccionar cliente aleatorio
        v_cliente_id := v_cliente_ids[1 + FLOOR(RANDOM() * ARRAY_LENGTH(v_cliente_ids, 1))::INTEGER];

        -- Número de items en la venta (entre 1 y 5)
        v_num_items := 1 + FLOOR(RANDOM() * 5)::INTEGER;

        -- Calcular monto total basado en items
        v_monto := 0;

        -- Insertar venta (sin monto aún, se calculará con los detalles)
        INSERT INTO ventas (
            id,
            tienda_id,
            vendedor_id,
            cliente_id,
            monto_total,
            estado,
            fecha_venta,
            created_at,
            updated_at
        ) VALUES (
            v_venta_id,
            v_tienda_id,
            v_vendedor_id,
            v_cliente_id,
            0, -- Se actualizará después
            v_estado,
            v_fecha,
            v_fecha,
            v_fecha
        );

        -- Crear detalles de venta
        FOR j IN 1..v_num_items LOOP
            -- Seleccionar producto aleatorio
            v_producto_id := v_producto_ids[1 + FLOOR(RANDOM() * ARRAY_LENGTH(v_producto_ids, 1))::INTEGER];

            -- Cantidad aleatoria (1-10 unidades)
            v_cantidad := 1 + FLOOR(RANDOM() * 10)::INTEGER;

            -- Obtener precio del producto
            SELECT precio INTO v_precio FROM productos WHERE id = v_producto_id;

            -- Calcular subtotal
            v_subtotal := v_precio * v_cantidad;
            v_monto := v_monto + v_subtotal;

            -- Insertar detalle de venta
            INSERT INTO ventas_detalles (
                venta_id,
                producto_id,
                cantidad,
                precio_unitario,
                subtotal,
                created_at
            ) VALUES (
                v_venta_id,
                v_producto_id,
                v_cantidad,
                v_precio,
                v_subtotal,
                v_fecha
            );
        END LOOP;

        -- Actualizar monto total de la venta
        UPDATE ventas SET monto_total = v_monto WHERE id = v_venta_id;

        -- Si la venta está completada, crear comisión (5% del monto)
        IF v_estado = 'COMPLETADA' THEN
            INSERT INTO comisiones (
                vendedor_id,
                venta_id,
                monto_comision,
                porcentaje,
                fecha_comision,
                created_at
            ) VALUES (
                v_vendedor_id,
                v_venta_id,
                v_monto * 0.05,
                5.00,
                v_fecha,
                v_fecha
            );
        END IF;
    END LOOP;

    RAISE NOTICE 'Se crearon 200 ventas con sus detalles y comisiones';
END $$;

-- ============================================
-- 7. SEED MENU OPTIONS (ELIMINADO)
-- ============================================
-- Los menús ahora se manejan exclusivamente en:
-- supabase/migrations/00000000000007_menu_permissions.sql
-- Este archivo seed.sql solo crea datos de prueba (tiendas, productos, clientes, ventas)

-- ============================================
-- 8. REFRESCAR VISTAS MATERIALIZADAS
-- ============================================

-- NOTA: Las vistas materializadas del dashboard no están implementadas en consolidación inicial
-- SELECT refresh_dashboard_metrics();

-- ============================================
-- RESUMEN DE SEED
-- ============================================

DO $$
DECLARE
    v_tiendas INTEGER;
    v_productos INTEGER;
    v_clientes INTEGER;
    v_usuarios INTEGER;
    v_ventas INTEGER;
    v_detalles INTEGER;
    v_comisiones INTEGER;
    v_asignaciones INTEGER;
BEGIN
    SELECT COUNT(*) INTO v_tiendas FROM tiendas;
    SELECT COUNT(*) INTO v_productos FROM productos;
    SELECT COUNT(*) INTO v_clientes FROM clientes;
    SELECT COUNT(*) INTO v_usuarios FROM auth.users WHERE email LIKE '%@test.com';
    SELECT COUNT(*) INTO v_ventas FROM ventas;
    SELECT COUNT(*) INTO v_detalles FROM ventas_detalles;
    SELECT COUNT(*) INTO v_comisiones FROM comisiones;
    SELECT COUNT(*) INTO v_asignaciones FROM user_tiendas;

    RAISE NOTICE '========================================';
    RAISE NOTICE 'SEED COMPLETADO EXITOSAMENTE';
    RAISE NOTICE '========================================';
    RAISE NOTICE 'Tiendas: %', v_tiendas;
    RAISE NOTICE 'Productos: %', v_productos;
    RAISE NOTICE 'Clientes: %', v_clientes;
    RAISE NOTICE 'Usuarios de prueba: %', v_usuarios;
    RAISE NOTICE 'Ventas generadas: %', v_ventas;
    RAISE NOTICE 'Detalles de venta: %', v_detalles;
    RAISE NOTICE 'Comisiones: %', v_comisiones;
    RAISE NOTICE 'Asignaciones user-tienda: %', v_asignaciones;
    RAISE NOTICE '========================================';
    RAISE NOTICE 'CREDENCIALES DE ACCESO:';
    RAISE NOTICE 'Admin:    admin@test.com    / asdasd211';
    RAISE NOTICE 'Gerente:  gerente@test.com  / asdasd211';
    RAISE NOTICE 'Vendedor: vendedor@test.com / asdasd211';
    RAISE NOTICE '========================================';
    RAISE NOTICE 'NOTA: Los menús se cargan desde migration 00000000000007';
    RAISE NOTICE '========================================';
END $$;