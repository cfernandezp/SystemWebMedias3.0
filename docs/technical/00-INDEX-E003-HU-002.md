# Índice Técnico - E003-HU-002: Sistema de Navegación con Menús Desplegables

**Historia de Usuario**: E003-HU-002
**Épica**: E003 - Dashboard y Sistema de Navegación
**Fecha creación**: 2025-10-06
**Estado**: 📋 Listo para Implementación

---

## 📚 DOCUMENTACIÓN TÉCNICA

### 📋 Especificaciones para Agentes
**Archivo principal**: [SPECS-FOR-AGENTS-E003-HU-002.md](SPECS-FOR-AGENTS-E003-HU-002.md)

Este es el documento MAESTRO que coordina la implementación. Contiene:
- Resumen ejecutivo
- Tareas por agente (@supabase-expert, @flutter-expert, @ux-ui-expert, @qa-testing-expert)
- Flujo de implementación paralelo
- Definition of Done (DoD)

---

### 🗄️ Backend (Supabase)

| Documento | Contenido | Responsable |
|-----------|-----------|-------------|
| [schema_E003-HU-002.md](backend/schema_E003-HU-002.md) | Tablas: `menu_options`, `menu_permissions` + Funciones SQL | @supabase-expert |
| [apis_E003-HU-002.md](backend/apis_E003-HU-002.md) | APIs: `get_menu_options`, `update_sidebar_preference`, `get_user_profile` | @supabase-expert |

**Tablas**:
- `menu_options`: Maestro de opciones de menú (jerárquico)
- `menu_permissions`: Permisos de menú por rol
- `users.sidebar_collapsed`: Preferencia de usuario

**Funciones PostgreSQL**:
- `get_menu_options(p_user_id)`: Devuelve menú jerárquico según rol
- `update_sidebar_preference(p_user_id, p_collapsed)`: Guarda preferencia
- `get_user_profile(p_user_id)`: Datos de usuario para header

---

### 📱 Frontend (Flutter - Clean Architecture)

| Documento | Contenido | Responsable |
|-----------|-----------|-------------|
| [models_E003-HU-002.md](frontend/models_E003-HU-002.md) | Models: `MenuOptionModel`, `MenuResponseModel`, `UserProfileModel` | @flutter-expert |

**Estructura de Feature**:
```
lib/features/menu/
├── data/
│   ├── datasources/menu_remote_datasource.dart
│   ├── models/menu_option_model.dart
│   └── repositories/menu_repository_impl.dart
├── domain/
│   ├── entities/menu_option.dart
│   ├── repositories/menu_repository.dart
│   └── usecases/get_menu_options.dart
└── presentation/
    └── bloc/menu_bloc.dart
```

**Models**:
- `MenuOptionModel`: Opción de menú con children anidados
- `MenuResponseModel`: Respuesta completa con rol + menú
- `UserProfileModel`: Datos de usuario (nombre, rol, avatar, sidebar_collapsed)

**Entities**:
- `MenuOption`: Entity del dominio
- `UserProfile`: Entity del usuario
- `Breadcrumb`: Miga de pan

---

### 🎨 Design System (UI/UX)

| Documento | Contenido | Responsable |
|-----------|-----------|-------------|
| [components_E003-HU-002.md](design/components_E003-HU-002.md) | Componentes: `AppSidebar`, `AppHeader`, `BreadcrumbsWidget` | @ux-ui-expert |
| [tokens.md](design/tokens.md) | Design tokens: Colores, spacing, animaciones | @ux-ui-expert |

**Componentes UI**:
- **AppSidebar**: Sidebar con menús expandibles/colapsables (280px / 80px)
- **AppHeader**: Header con breadcrumbs + perfil de usuario
- **BreadcrumbsWidget**: Migas de pan con navegación
- **LogoutConfirmationDialog**: Modal de confirmación de logout
- **MainLayout**: Layout completo (Sidebar + Header + Content)

**Design Specs**:
- Colores: Primary `#4ECDC4`, Primary Dark `#26A69A`
- Animaciones: 200ms (hover), 300ms (transiciones)
- Responsive: Desktop (≥1200px), Tablet (768-1199px), Mobile (<768px)

---

### 🔄 Integración (Backend ↔ Frontend)

| Documento | Contenido | Responsable |
|-----------|-----------|-------------|
| [mapping_E003-HU-002.md](integration/mapping_E003-HU-002.md) | Mapping snake_case ↔ camelCase + Flujos de datos | @web-architect-expert |

**Mapping Crítico**:
- `nombre_completo` ↔ `nombreCompleto`
- `avatar_url` ↔ `avatarUrl`
- `sidebar_collapsed` ↔ `sidebarCollapsed`

**Flujos**:
1. Login → Cargar menú → Renderizar sidebar
2. Toggle sidebar → Guardar preferencia → Actualizar UI
3. Logout → Confirmación → Limpiar sesión → Redirigir

---

## 👥 AGENTES Y RESPONSABILIDADES

### @supabase-expert
**Tiempo estimado**: 2-3 horas

**Tareas**:
- [x] Crear schema de tablas
- [x] Implementar funciones PostgreSQL
- [x] Aplicar seed data (menús + permisos)
- [x] Configurar RLS

**Archivos**:
- `supabase/migrations/20250106XXXXXX_hu002_navigation_menus.sql`
- `supabase/seed/seed_menu_options.sql`

---

### @flutter-expert
**Tiempo estimado**: 4-5 horas

**Tareas**:
- [x] Implementar Data Layer (models, datasources, repositories)
- [x] Implementar Domain Layer (entities, use cases)
- [x] Implementar Presentation Layer (MenuBloc)
- [x] Integrar con AppRouter (GoRouter)
- [x] Unit tests (>85% coverage)

**Archivos**:
- `lib/features/menu/`
- `test/features/menu/`

---

### @ux-ui-expert
**Tiempo estimado**: 4-5 horas

**Tareas**:
- [x] Implementar AppSidebar (expandible/colapsable)
- [x] Implementar AppHeader (breadcrumbs + perfil)
- [x] Implementar BreadcrumbsWidget
- [x] Implementar MainLayout
- [x] Implementar animaciones fluidas
- [x] Widget tests

**Archivos**:
- `lib/shared/design_system/organisms/`
- `lib/shared/design_system/molecules/`
- `test/shared/design_system/`

---

### @qa-testing-expert
**Tiempo estimado**: 2-3 horas

**Tareas**:
- [x] Validar todos los Criterios de Aceptación (CA-001 a CA-008)
- [x] Integration tests E2E
- [x] Tests de seguridad (permisos por rol)
- [x] Tests de performance (<500ms carga)

**Archivos**:
- `integration_test/navigation_menu_test.dart`

---

## 📊 CRITERIOS DE ACEPTACIÓN

### CA-001: Sidebar con Menús según Rol de Vendedor ✅
- Dashboard, POS, Productos (solo catálogo), Inventario (solo lectura), Ventas, Clientes, Reportes

### CA-002: Sidebar con Menús según Rol de Gerente ✅
- Todo lo de Vendedor + Personas (clientes/proveedores), Transferencias, Comisiones del equipo

### CA-003: Sidebar con Menús según Rol de Admin ✅
- Menú completo: Todo lo anterior + Admin (usuarios/tiendas), Productos (marcas/materiales/tipos/tallas)

### CA-004: Comportamiento de Menús Desplegables ✅
- Click en menú con ícono ▼ → Expande/colapsa sub-opciones
- Rotación de ícono ▲/▼

### CA-005: Sidebar Colapsable ✅
- Click en hamburguesa → Colapsa/expande sidebar
- Sidebar colapsado muestra solo íconos + tooltips

### CA-006: Header con Perfil de Usuario y Logout ✅
- Avatar + nombre + rol (badge)
- Dropdown: Ver perfil, Configuración, Cerrar sesión
- Modal de confirmación en logout

### CA-007: Indicador de Página Activa ✅
- Background turquesa + texto blanco + border-left 4px

### CA-008: Breadcrumbs de Navegación ✅
- Breadcrumbs dinámicos según ruta
- Clickeables para navegar

---

## 🚀 FLUJO DE IMPLEMENTACIÓN

### Fase 1: Implementación Paralela (Día 1)
- **@supabase-expert**: Backend (schema + funciones)
- **@flutter-expert**: Data + Domain Layers
- **@ux-ui-expert**: Componentes UI

### Fase 2: Integración (Día 2)
- **@flutter-expert**: Integrar Bloc + Router
- **@ux-ui-expert**: Ajustar animaciones + responsive

### Fase 3: Testing (Día 2)
- **@flutter-expert**: Unit tests
- **@ux-ui-expert**: Widget tests
- **@qa-testing-expert**: Integration tests + Validación CA

---

## 📋 DEFINITION OF DONE

- [x] Backend: Tablas, funciones, RLS, seed data
- [x] Frontend: Models, entities, repositories, Bloc
- [x] UI: Componentes siguiendo Design System
- [x] Tests: Unit (>85%), Widget, Integration
- [x] QA: Todos los CA validados
- [x] Documentación: Código comentado

---

## 🔗 ENLACES RÁPIDOS

- **HU Original**: [E003-HU-002-navegacion-menus.md](../historias-usuario/E003-HU-002-navegacion-menus.md)
- **Convenciones**: [00-CONVENTIONS.md](00-CONVENTIONS.md)
- **Design Tokens**: [design/tokens.md](design/tokens.md)
- **Specs Agentes**: [SPECS-FOR-AGENTS-E003-HU-002.md](SPECS-FOR-AGENTS-E003-HU-002.md)

---

**Última actualización**: 2025-10-06 por @web-architect-expert