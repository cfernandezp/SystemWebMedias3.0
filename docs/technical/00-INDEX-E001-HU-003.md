# √çndice T√©cnico - E001-HU-003: Logout Seguro

**Historia de Usuario**: E001-HU-003 - Logout Seguro
**Arquitecto**: @web-architect-expert
**Fecha de dise√±o**: 2025-10-06
**Estado**: üîµ En Desarrollo

---

## üìã √çNDICE DE DOCUMENTACI√ìN

### Backend (Supabase)
- [Schema BD](backend/schema_E001-HU-003.md) - Tablas y estructura de datos
- [APIs/Functions](backend/apis_E001-HU-003.md) - Funciones PostgreSQL

### Frontend (Flutter)
- [Models](frontend/models_E001-HU-003.md) - Modelos Dart

### UX/UI
- [Components](design/components_E001-HU-003.md) - Componentes de interfaz

### Integration
- [Mapping](integration/mapping_E001-HU-003.md) - Mapeo Backend ‚Üî Frontend

---

## üéØ OBJETIVO DE LA HU

Implementar cierre de sesi√≥n seguro con:
- Confirmaci√≥n de logout manual
- Limpieza completa de sesi√≥n
- Invalidaci√≥n de tokens (blacklist)
- Detecci√≥n de inactividad (2 horas)
- Sincronizaci√≥n multi-pesta√±a
- Auditor√≠a de eventos de seguridad

---

## üîë COMPONENTES PRINCIPALES

### Backend
1. **token_blacklist** - Tokens invalidados
2. **audit_logs** - Auditor√≠a de seguridad
3. **users.last_activity_at** - Tracking de actividad
4. **logout_user()** - Funci√≥n de logout
5. **check_inactivity()** - Verificar inactividad
6. **cleanup_expired_blacklist()** - Limpieza autom√°tica

### Frontend
1. **LogoutConfirmationDialog** - Modal de confirmaci√≥n
2. **InactivityWarningDialog** - Warning antes de logout autom√°tico
3. **UserMenuDropdown** - Men√∫ de usuario con logout
4. **InactivityTimerService** - Servicio de timer
5. **MultiTabSyncService** - Sincronizaci√≥n entre pesta√±as

---

## üìä REGLAS DE NEGOCIO APLICADAS

- **RN-003-LOGOUT.1**: Confirmaci√≥n de logout manual
- **RN-003-LOGOUT.2**: Limpieza completa de sesi√≥n
- **RN-003-LOGOUT.3**: Invalidaci√≥n de token
- **RN-003-LOGOUT.4**: Redirecci√≥n post-logout
- **RN-003-LOGOUT.5**: Logout por inactividad (2 horas)
- **RN-003-LOGOUT.6**: Sincronizaci√≥n multi-pesta√±a
- **RN-003-LOGOUT.7**: Logout con "Recordarme"
- **RN-003-LOGOUT.8**: Logout por token expirado
- **RN-003-LOGOUT.9**: Auditor√≠a de logouts
- **RN-003-LOGOUT.10**: Visibilidad de opci√≥n logout

---

## üîÑ FLUJO PRINCIPAL

### Logout Manual:
1. Usuario hace clic en "Cerrar Sesi√≥n" en UserMenuDropdown
2. Sistema muestra LogoutConfirmationDialog
3. Usuario confirma ‚Üí AuthBloc.add(LogoutRequested())
4. Backend invalida token (token_blacklist) y registra evento (audit_logs)
5. Frontend limpia SecureStorage y estado
6. Redirige a /login con mensaje "Sesi√≥n cerrada exitosamente"
7. Otras pesta√±as detectan cambio y tambi√©n cierran sesi√≥n

### Logout por Inactividad:
1. InactivityTimerService detecta 115 minutos sin actividad
2. Sistema muestra InactivityWarningDialog (5 minutos de aviso)
3. Si usuario no interact√∫a ‚Üí AuthBloc.add(InactivityDetected())
4. Backend invalida token (reason='inactivity')
5. Redirige a /login con mensaje "Sesi√≥n cerrada por inactividad"

---

## üöÄ SIGUIENTES PASOS

1. @supabase-expert: Implementar schema + functions seg√∫n `backend/`
2. @flutter-expert: Implementar models + services seg√∫n `frontend/`
3. @ux-ui-expert: Implementar componentes UI seg√∫n `design/`
4. @flutter-expert: Integraci√≥n final end-to-end
5. @qa-testing-expert: Validaci√≥n completa

---

**√öltima actualizaci√≥n**: 2025-10-06
