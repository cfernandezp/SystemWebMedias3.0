# Índice de Documentación - HU-004: Recuperar Contraseña

**Epic**: E001 - Autenticación
**Historia**: E001-HU-004 - Recuperar Contraseña
**Fecha**: 2025-10-06
**Estado**: ✅ Backend Completado

---

## Documentos Disponibles

### 1. Especificaciones Técnicas
📄 **Archivo**: `docs/technical/00-SPECS-HU-004-PASSWORD-RECOVERY.md`
- Resumen completo de funcionalidad
- Especificaciones backend (SQL)
- Especificaciones frontend (Dart)
- Especificaciones UI (Widgets)
- Flujos de usuario
- Reglas de seguridad
- **Estado**: ✅ Completo

### 2. Backend - Schema
📄 **Archivo**: `docs/technical/backend/schema_E001-HU-004.md`
- Estructura tabla password_recovery
- Índices y constraints
- Comentarios de documentación
- Reglas de negocio aplicadas
- Relaciones con otras tablas
- Guía de verificación
- **Estado**: ✅ Implementado

### 3. Backend - APIs
📄 **Archivo**: `docs/technical/backend/apis_E001-HU-004.md`
- 4 funciones PostgreSQL completas:
  - request_password_reset()
  - validate_reset_token()
  - reset_password()
  - cleanup_expired_recovery_tokens()
- Firmas, parámetros y retornos
- Casos de error con hints
- Lógica de negocio detallada
- Scripts de testing manual
- Diagrama de integración
- **Estado**: ✅ Implementado

### 4. Integration - Mapping
📄 **Archivo**: `docs/technical/integration/mapping_E001-HU-004.md`
- Convenciones de naming (PostgreSQL ↔ Dart)
- Mapping de columnas y tipos
- Mapping de funciones a eventos BLoC
- Mapping de errores y hints
- Ejemplos de integración completa
- Casos de uso detallados
- Guía de testing
- **Estado**: ✅ Documentado

### 5. Reporte de Implementación
📄 **Archivo**: `docs/technical/00-IMPLEMENTATION-REPORT-E001-HU-004.md`
- Resumen ejecutivo
- Archivos creados/modificados
- Implementación detallada
- Reglas de negocio cumplidas
- Testing ejecutado
- Seguridad implementada
- Próximos pasos
- Métricas y conclusiones
- **Estado**: ✅ Completo

---

## Archivos de Código

### Backend (Supabase)

#### Migration
📁 **Archivo**: `supabase/migrations/20251006214500_hu004_password_recovery.sql`
- Tabla password_recovery (8 columnas)
- 4 índices optimizados
- 4 funciones PostgreSQL
- Comentarios inline
- **Estado**: ✅ Aplicado exitosamente

#### Verification Script
📁 **Archivo**: `verify_hu004.sql`
- Queries de verificación
- Tests de funciones
- Consultas de auditoría
- **Estado**: ✅ Creado

---

## Estructura de Navegación

```
docs/technical/
├── 00-SPECS-HU-004-PASSWORD-RECOVERY.md       [Especificaciones]
├── 00-IMPLEMENTATION-REPORT-E001-HU-004.md    [Reporte]
├── 00-INDEX-E001-HU-004.md                    [Este archivo]
├── backend/
│   ├── schema_E001-HU-004.md                  [Schema DB]
│   └── apis_E001-HU-004.md                    [Funciones]
└── integration/
    └── mapping_E001-HU-004.md                 [Mapping]

supabase/
├── migrations/
│   └── 20251006214500_hu004_password_recovery.sql [Migration]
└── verify_hu004.sql                            [Testing]
```

---

## Flujo de Lectura Recomendado

### Para @flutter-expert (Frontend)
1. ✅ Leer: `00-SPECS-HU-004-PASSWORD-RECOVERY.md` (sección Frontend)
2. ✅ Leer: `mapping_E001-HU-004.md` (completo)
3. ✅ Leer: `apis_E001-HU-004.md` (sección Integración con Frontend)
4. ⏳ Implementar: Models, Pages, BLoC
5. ⏳ Consultar: `mapping_E001-HU-004.md` para nombres exactos

### Para @ux-ui-expert (UI)
1. ✅ Leer: `00-SPECS-HU-004-PASSWORD-RECOVERY.md` (sección UI Components)
2. ✅ Leer: `mapping_E001-HU-004.md` (sección Error Handling)
3. ⏳ Implementar: Widgets, Forms, Dialogs
4. ⏳ Consultar: `mapping_E001-HU-004.md` para mensajes de error

### Para @qa-testing-expert (Testing)
1. ✅ Leer: `00-IMPLEMENTATION-REPORT-E001-HU-004.md` (sección Testing)
2. ✅ Leer: `mapping_E001-HU-004.md` (sección Testing)
3. ✅ Ejecutar: `verify_hu004.sql`
4. ⏳ Implementar: Unit tests, Integration tests, E2E tests

### Para @web-architect-expert (Revisión)
1. ✅ Leer: `00-IMPLEMENTATION-REPORT-E001-HU-004.md` (completo)
2. ✅ Verificar: Convenciones seguidas
3. ✅ Revisar: Decisiones técnicas
4. ✅ Aprobar: Para integración frontend

---

## Datos Técnicos Clave

### Tabla: password_recovery

| Columna | Tipo | Constraint | Descripción |
|---------|------|------------|-------------|
| id | UUID | PK | Identificador único |
| user_id | UUID | FK, NOT NULL | Usuario (auth.users) |
| email | TEXT | NOT NULL | Email del usuario |
| token | TEXT | UNIQUE, NOT NULL | Token URL-safe (32 bytes) |
| expires_at | TIMESTAMP | NOT NULL | Expiración (24h) |
| used_at | TIMESTAMP | NULL | Marca de uso |
| ip_address | INET | NULL | IP de origen |
| created_at | TIMESTAMP | DEFAULT NOW() | Timestamp creación |

### Funciones PostgreSQL

| Función | Propósito | Parámetros | Retorno |
|---------|-----------|------------|---------|
| request_password_reset() | Solicitar recuperación | email, ip? | {success, data/error} |
| validate_reset_token() | Validar token | token | {success, data/error} |
| reset_password() | Cambiar password | token, password, ip? | {success, data/error} |
| cleanup_expired_recovery_tokens() | Limpieza | - | {success, data/error} |

### Reglas de Seguridad

- ⏰ **Expiración**: 24 horas
- 🚫 **Rate limiting**: 3 solicitudes / 15 minutos
- 🔐 **Token**: 32 bytes random, URL-safe, uso único
- 🔒 **Password**: Mínimo 8 caracteres
- 🕵️ **Privacidad**: No revela si email existe
- 📝 **Auditoría**: Registro en audit_log
- 🚪 **Sesiones**: Invalidadas al cambiar password

### Error Hints

| Hint | Significado | Acción UI |
|------|-------------|-----------|
| invalid_email | Email mal formado | Mostrar error en campo |
| rate_limit | Excedió límite | Esperar 15 min |
| missing_token | Token vacío | Error técnico |
| invalid_token | Token no existe | Enlace inválido |
| expired_token | Token expirado | Solicitar nuevo enlace |
| used_token | Token ya usado | Ir a login |
| weak_password | Password < 8 chars | Mejorar contraseña |

---

## Checklist de Implementación

### Backend (Supabase) - @supabase-expert
- [x] Tabla password_recovery creada
- [x] Índices aplicados
- [x] Función request_password_reset() implementada
- [x] Función validate_reset_token() implementada
- [x] Función reset_password() implementada
- [x] Función cleanup_expired_recovery_tokens() implementada
- [x] Migration aplicada exitosamente
- [x] Testing manual completado
- [x] Documentación creada

### Frontend (Flutter) - @flutter-expert
- [ ] PasswordResetRequestModel
- [ ] PasswordResetResponseModel
- [ ] ResetPasswordModel
- [ ] TokenValidationResponseModel
- [ ] ForgotPasswordPage
- [ ] ResetPasswordPage
- [ ] AuthBloc events (3)
- [ ] AuthBloc states (6)
- [ ] Rutas /forgot-password, /reset-password
- [ ] Integración con Supabase RPC
- [ ] Manejo de errores
- [ ] Testing unitario

### UI (Design System) - @ux-ui-expert
- [ ] ForgotPasswordForm
- [ ] ResetPasswordForm
- [ ] PasswordStrengthIndicator
- [ ] EmailSentConfirmation
- [ ] TokenExpiredDialog
- [ ] TokenInvalidDialog
- [ ] TokenUsedDialog
- [ ] RateLimitWarning
- [ ] Success/Error Snackbars
- [ ] Responsive design

### Testing - @qa-testing-expert
- [x] Backend: Tests manuales
- [ ] Frontend: Unit tests models
- [ ] Frontend: Unit tests BLoC
- [ ] Frontend: Widget tests pages
- [ ] Integration: Flujo completo
- [ ] E2E: Con email real

### DevOps - @web-architect-expert
- [ ] Edge Function: send-recovery-email
- [ ] Servicio de emails (SendGrid/Mailgun)
- [ ] Templates de email
- [ ] Cron job: cleanup diario
- [ ] Monitoring y alertas

---

## Dependencias entre Componentes

### HU-004 depende de:
- ✅ HU-001: Tabla auth.users (email, encrypted_password)
- ✅ HU-003: Tabla audit_log (para registrar password_reset)
- ✅ HU-002: Sistema de autenticación (refresh_tokens)

### Componentes que dependerán de HU-004:
- ⏳ Email Service (envío de enlaces)
- ⏳ User Profile (cambiar password desde perfil)
- ⏳ Admin Panel (monitoreo de recuperaciones)

---

## Recursos Adicionales

### Testing Manual
```bash
# Ejecutar script de verificación
# (Requiere acceso a base de datos local)
psql -U postgres -d postgres < verify_hu004.sql
```

### Verificar Migration
```bash
# Ver migrations aplicadas
npx supabase db list

# Ver detalle de tabla
npx supabase db diff
```

### Consultas Útiles
```sql
-- Ver tokens activos
SELECT id, email, substring(token, 1, 10) || '...' as token,
       expires_at, used_at
FROM password_recovery
WHERE expires_at > NOW() AND used_at IS NULL;

-- Ver estadísticas
SELECT
  COUNT(*) as total,
  COUNT(CASE WHEN used_at IS NOT NULL THEN 1 END) as usados,
  COUNT(CASE WHEN expires_at < NOW() THEN 1 END) as expirados
FROM password_recovery;
```

---

## FAQ

### ¿Cómo pruebo la funcionalidad sin email real?
El backend retorna el token en la respuesta de `request_password_reset()`. Puedes copiar ese token y usarlo directamente en `reset_password()` para testing.

### ¿Qué pasa si un usuario solicita múltiples veces?
Se aplica rate limiting: máximo 3 solicitudes en 15 minutos. Los tokens anteriores se invalidan al generar uno nuevo.

### ¿Los tokens son seguros?
Sí. Son 32 bytes random generados con `gen_random_bytes()`, codificados en base64 URL-safe, únicos en BD, y expiran en 24 horas.

### ¿Se puede reutilizar un token?
No. Una vez usado (used_at se marca), el token no puede volver a usarse. La validación rechaza tokens con used_at != NULL.

### ¿Qué pasa con las sesiones activas al cambiar password?
Se eliminan todos los refresh_tokens del usuario, forzando re-login en todos los dispositivos.

### ¿Cómo implemento el envío de emails?
Pendiente. Se recomienda crear una Edge Function que llame a un servicio externo (SendGrid, Mailgun, Resend) con el token recibido de `request_password_reset()`.

---

## Contacto y Soporte

### Para preguntas sobre:
- **Backend/DB**: @supabase-expert
- **Frontend/Dart**: @flutter-expert
- **UI/UX**: @ux-ui-expert
- **Testing**: @qa-testing-expert
- **Arquitectura**: @web-architect-expert

### Referencias
- Especificaciones: `00-SPECS-HU-004-PASSWORD-RECOVERY.md`
- Convenciones: `00-CONVENTIONS.md`
- Sistema general: `SISTEMA_DOCUMENTACION.md`

---

**Creado por**: @supabase-expert
**Fecha**: 2025-10-06
**Versión**: 1.0
**Estado**: ✅ Actualizado
