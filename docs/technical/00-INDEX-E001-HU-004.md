# Ãndice de DocumentaciÃ³n - HU-004: Recuperar ContraseÃ±a

**Epic**: E001 - AutenticaciÃ³n
**Historia**: E001-HU-004 - Recuperar ContraseÃ±a
**Fecha**: 2025-10-06
**Estado**: âœ… Backend Completado

---

## Documentos Disponibles

### 1. Especificaciones TÃ©cnicas
ğŸ“„ **Archivo**: `docs/technical/00-SPECS-HU-004-PASSWORD-RECOVERY.md`
- Resumen completo de funcionalidad
- Especificaciones backend (SQL)
- Especificaciones frontend (Dart)
- Especificaciones UI (Widgets)
- Flujos de usuario
- Reglas de seguridad
- **Estado**: âœ… Completo

### 2. Backend - Schema
ğŸ“„ **Archivo**: `docs/technical/backend/schema_E001-HU-004.md`
- Estructura tabla password_recovery
- Ãndices y constraints
- Comentarios de documentaciÃ³n
- Reglas de negocio aplicadas
- Relaciones con otras tablas
- GuÃ­a de verificaciÃ³n
- **Estado**: âœ… Implementado

### 3. Backend - APIs
ğŸ“„ **Archivo**: `docs/technical/backend/apis_E001-HU-004.md`
- 4 funciones PostgreSQL completas:
  - request_password_reset()
  - validate_reset_token()
  - reset_password()
  - cleanup_expired_recovery_tokens()
- Firmas, parÃ¡metros y retornos
- Casos de error con hints
- LÃ³gica de negocio detallada
- Scripts de testing manual
- Diagrama de integraciÃ³n
- **Estado**: âœ… Implementado

### 4. Integration - Mapping
ğŸ“„ **Archivo**: `docs/technical/integration/mapping_E001-HU-004.md`
- Convenciones de naming (PostgreSQL â†” Dart)
- Mapping de columnas y tipos
- Mapping de funciones a eventos BLoC
- Mapping de errores y hints
- Ejemplos de integraciÃ³n completa
- Casos de uso detallados
- GuÃ­a de testing
- **Estado**: âœ… Documentado

### 5. Reporte de ImplementaciÃ³n
ğŸ“„ **Archivo**: `docs/technical/00-IMPLEMENTATION-REPORT-E001-HU-004.md`
- Resumen ejecutivo
- Archivos creados/modificados
- ImplementaciÃ³n detallada
- Reglas de negocio cumplidas
- Testing ejecutado
- Seguridad implementada
- PrÃ³ximos pasos
- MÃ©tricas y conclusiones
- **Estado**: âœ… Completo

---

## Archivos de CÃ³digo

### Backend (Supabase)

#### Migration
ğŸ“ **Archivo**: `supabase/migrations/20251006214500_hu004_password_recovery.sql`
- Tabla password_recovery (8 columnas)
- 4 Ã­ndices optimizados
- 4 funciones PostgreSQL
- Comentarios inline
- **Estado**: âœ… Aplicado exitosamente

#### Verification Script
ğŸ“ **Archivo**: `verify_hu004.sql`
- Queries de verificaciÃ³n
- Tests de funciones
- Consultas de auditorÃ­a
- **Estado**: âœ… Creado

---

## Estructura de NavegaciÃ³n

```
docs/technical/
â”œâ”€â”€ 00-SPECS-HU-004-PASSWORD-RECOVERY.md       [Especificaciones]
â”œâ”€â”€ 00-IMPLEMENTATION-REPORT-E001-HU-004.md    [Reporte]
â”œâ”€â”€ 00-INDEX-E001-HU-004.md                    [Este archivo]
â”œâ”€â”€ backend/
â”‚   â”œâ”€â”€ schema_E001-HU-004.md                  [Schema DB]
â”‚   â””â”€â”€ apis_E001-HU-004.md                    [Funciones]
â””â”€â”€ integration/
    â””â”€â”€ mapping_E001-HU-004.md                 [Mapping]

supabase/
â”œâ”€â”€ migrations/
â”‚   â””â”€â”€ 20251006214500_hu004_password_recovery.sql [Migration]
â””â”€â”€ verify_hu004.sql                            [Testing]
```

---

## Flujo de Lectura Recomendado

### Para @flutter-expert (Frontend)
1. âœ… Leer: `00-SPECS-HU-004-PASSWORD-RECOVERY.md` (secciÃ³n Frontend)
2. âœ… Leer: `mapping_E001-HU-004.md` (completo)
3. âœ… Leer: `apis_E001-HU-004.md` (secciÃ³n IntegraciÃ³n con Frontend)
4. â³ Implementar: Models, Pages, BLoC
5. â³ Consultar: `mapping_E001-HU-004.md` para nombres exactos

### Para @ux-ui-expert (UI)
1. âœ… Leer: `00-SPECS-HU-004-PASSWORD-RECOVERY.md` (secciÃ³n UI Components)
2. âœ… Leer: `mapping_E001-HU-004.md` (secciÃ³n Error Handling)
3. â³ Implementar: Widgets, Forms, Dialogs
4. â³ Consultar: `mapping_E001-HU-004.md` para mensajes de error

### Para @qa-testing-expert (Testing)
1. âœ… Leer: `00-IMPLEMENTATION-REPORT-E001-HU-004.md` (secciÃ³n Testing)
2. âœ… Leer: `mapping_E001-HU-004.md` (secciÃ³n Testing)
3. âœ… Ejecutar: `verify_hu004.sql`
4. â³ Implementar: Unit tests, Integration tests, E2E tests

### Para @web-architect-expert (RevisiÃ³n)
1. âœ… Leer: `00-IMPLEMENTATION-REPORT-E001-HU-004.md` (completo)
2. âœ… Verificar: Convenciones seguidas
3. âœ… Revisar: Decisiones tÃ©cnicas
4. âœ… Aprobar: Para integraciÃ³n frontend

---

## Datos TÃ©cnicos Clave

### Tabla: password_recovery

| Columna | Tipo | Constraint | DescripciÃ³n |
|---------|------|------------|-------------|
| id | UUID | PK | Identificador Ãºnico |
| user_id | UUID | FK, NOT NULL | Usuario (auth.users) |
| email | TEXT | NOT NULL | Email del usuario |
| token | TEXT | UNIQUE, NOT NULL | Token URL-safe (32 bytes) |
| expires_at | TIMESTAMP | NOT NULL | ExpiraciÃ³n (24h) |
| used_at | TIMESTAMP | NULL | Marca de uso |
| ip_address | INET | NULL | IP de origen |
| created_at | TIMESTAMP | DEFAULT NOW() | Timestamp creaciÃ³n |

### Funciones PostgreSQL

| FunciÃ³n | PropÃ³sito | ParÃ¡metros | Retorno |
|---------|-----------|------------|---------|
| request_password_reset() | Solicitar recuperaciÃ³n | email, ip? | {success, data/error} |
| validate_reset_token() | Validar token | token | {success, data/error} |
| reset_password() | Cambiar password | token, password, ip? | {success, data/error} |
| cleanup_expired_recovery_tokens() | Limpieza | - | {success, data/error} |

### Reglas de Seguridad

- â° **ExpiraciÃ³n**: 24 horas
- ğŸš« **Rate limiting**: 3 solicitudes / 15 minutos
- ğŸ” **Token**: 32 bytes random, URL-safe, uso Ãºnico
- ğŸ”’ **Password**: MÃ­nimo 8 caracteres
- ğŸ•µï¸ **Privacidad**: No revela si email existe
- ğŸ“ **AuditorÃ­a**: Registro en audit_log
- ğŸšª **Sesiones**: Invalidadas al cambiar password

### Error Hints

| Hint | Significado | AcciÃ³n UI |
|------|-------------|-----------|
| invalid_email | Email mal formado | Mostrar error en campo |
| rate_limit | ExcediÃ³ lÃ­mite | Esperar 15 min |
| missing_token | Token vacÃ­o | Error tÃ©cnico |
| invalid_token | Token no existe | Enlace invÃ¡lido |
| expired_token | Token expirado | Solicitar nuevo enlace |
| used_token | Token ya usado | Ir a login |
| weak_password | Password < 8 chars | Mejorar contraseÃ±a |

---

## Checklist de ImplementaciÃ³n

### Backend (Supabase) - @supabase-expert
- [x] Tabla password_recovery creada
- [x] Ãndices aplicados
- [x] FunciÃ³n request_password_reset() implementada
- [x] FunciÃ³n validate_reset_token() implementada
- [x] FunciÃ³n reset_password() implementada
- [x] FunciÃ³n cleanup_expired_recovery_tokens() implementada
- [x] Migration aplicada exitosamente
- [x] Testing manual completado
- [x] DocumentaciÃ³n creada

### Frontend (Flutter) - @flutter-expert
- [ ] PasswordResetRequestModel
- [ ] PasswordResetResponseModel
- [ ] ResetPasswordModel
- [ ] TokenValidationResponseModel
- [ ] ForgotPasswordPage
- [ ] ResetPasswordPage
- [ ] AuthBloc events (3)
- [ ] AuthBloc states (6)
- [ ] Rutas /forgot-password, /reset-password
- [ ] IntegraciÃ³n con Supabase RPC
- [ ] Manejo de errores
- [ ] Testing unitario

### UI (Design System) - @ux-ui-expert
- [ ] ForgotPasswordForm
- [ ] ResetPasswordForm
- [ ] PasswordStrengthIndicator
- [ ] EmailSentConfirmation
- [ ] TokenExpiredDialog
- [ ] TokenInvalidDialog
- [ ] TokenUsedDialog
- [ ] RateLimitWarning
- [ ] Success/Error Snackbars
- [ ] Responsive design

### Testing - @qa-testing-expert
- [x] Backend: Tests manuales
- [ ] Frontend: Unit tests models
- [ ] Frontend: Unit tests BLoC
- [ ] Frontend: Widget tests pages
- [ ] Integration: Flujo completo
- [ ] E2E: Con email real

### DevOps - @web-architect-expert
- [ ] Edge Function: send-recovery-email
- [ ] Servicio de emails (SendGrid/Mailgun)
- [ ] Templates de email
- [ ] Cron job: cleanup diario
- [ ] Monitoring y alertas

---

## Dependencias entre Componentes

### HU-004 depende de:
- âœ… HU-001: Tabla auth.users (email, encrypted_password)
- âœ… HU-003: Tabla audit_log (para registrar password_reset)
- âœ… HU-002: Sistema de autenticaciÃ³n (refresh_tokens)

### Componentes que dependerÃ¡n de HU-004:
- â³ Email Service (envÃ­o de enlaces)
- â³ User Profile (cambiar password desde perfil)
- â³ Admin Panel (monitoreo de recuperaciones)

---

## Recursos Adicionales

### Testing Manual
```bash
# Ejecutar script de verificaciÃ³n
# (Requiere acceso a base de datos local)
psql -U postgres -d postgres < verify_hu004.sql
```

### Verificar Migration
```bash
# Ver migrations aplicadas
npx supabase db list

# Ver detalle de tabla
npx supabase db diff
```

### Consultas Ãštiles
```sql
-- Ver tokens activos
SELECT id, email, substring(token, 1, 10) || '...' as token,
       expires_at, used_at
FROM password_recovery
WHERE expires_at > NOW() AND used_at IS NULL;

-- Ver estadÃ­sticas
SELECT
  COUNT(*) as total,
  COUNT(CASE WHEN used_at IS NOT NULL THEN 1 END) as usados,
  COUNT(CASE WHEN expires_at < NOW() THEN 1 END) as expirados
FROM password_recovery;
```

---

## FAQ

### Â¿CÃ³mo pruebo la funcionalidad sin email real?
El backend retorna el token en la respuesta de `request_password_reset()`. Puedes copiar ese token y usarlo directamente en `reset_password()` para testing.

### Â¿QuÃ© pasa si un usuario solicita mÃºltiples veces?
Se aplica rate limiting: mÃ¡ximo 3 solicitudes en 15 minutos. Los tokens anteriores se invalidan al generar uno nuevo.

### Â¿Los tokens son seguros?
SÃ­. Son 32 bytes random generados con `gen_random_bytes()`, codificados en base64 URL-safe, Ãºnicos en BD, y expiran en 24 horas.

### Â¿Se puede reutilizar un token?
No. Una vez usado (used_at se marca), el token no puede volver a usarse. La validaciÃ³n rechaza tokens con used_at != NULL.

### Â¿QuÃ© pasa con las sesiones activas al cambiar password?
Se eliminan todos los refresh_tokens del usuario, forzando re-login en todos los dispositivos.

### Â¿CÃ³mo implemento el envÃ­o de emails?
Pendiente. Se recomienda crear una Edge Function que llame a un servicio externo (SendGrid, Mailgun, Resend) con el token recibido de `request_password_reset()`.

---

## Contacto y Soporte

### Para preguntas sobre:
- **Backend/DB**: @supabase-expert
- **Frontend/Dart**: @flutter-expert
- **UI/UX**: @ux-ui-expert
- **Testing**: @qa-testing-expert
- **Arquitectura**: @web-architect-expert

### Referencias
- Especificaciones: `00-SPECS-HU-004-PASSWORD-RECOVERY.md`
- Convenciones: `00-CONVENTIONS.md`
- Sistema general: `SISTEMA_DOCUMENTACION.md`

---

**Creado por**: @supabase-expert
**Fecha**: 2025-10-06
**VersiÃ³n**: 1.0
**Estado**: âœ… Actualizado
