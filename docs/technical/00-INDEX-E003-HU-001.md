# √çndice T√©cnico - E003-HU-001: Dashboard Principal con M√©tricas

**Historia de Usuario**: E003-HU-001
**√âpica**: E003 - Dashboard y Sistema de Navegaci√≥n
**Responsable**: @web-architect-expert
**Fecha**: 2025-10-06
**Estado**: üé® Arquitectura Dise√±ada

---

## üìã DOCUMENTOS T√âCNICOS

### 1. Backend (Supabase Local)

- **[schema_E003-HU-001.md](backend/schema_E003-HU-001.md)**
  - Tablas de negocio base (tiendas, productos, clientes, ventas)
  - Vistas materializadas por rol (vendedor, gerente, admin)
  - Funciones de m√©tricas (`get_dashboard_metrics`, `get_sales_chart_data`, etc.)
  - RLS Policies por rol
  - √çndices de performance

- **[apis_E003-HU-001.md](backend/apis_E003-HU-001.md)**
  - Endpoint `get_dashboard_metrics()` - M√©tricas seg√∫n rol
  - Endpoint `get_sales_chart_data()` - Gr√°fico ventas mensuales
  - Endpoint `get_top_productos()` - Top 5 productos m√°s vendidos
  - Endpoint `get_top_vendedores()` - Top 5 vendedores del mes
  - Endpoint `get_transacciones_recientes()` - √öltimas transacciones
  - Endpoint `get_productos_stock_bajo()` - Productos con alerta
  - Endpoint `refresh_dashboard_metrics()` - Refrescar vistas

---

### 2. Frontend (Flutter Web)

- **[models_E003-HU-001.md](frontend/models_E003-HU-001.md)**
  - Entities: `DashboardMetrics` (polim√≥rfica), `VendedorMetrics`, `GerenteMetrics`, `AdminMetrics`
  - Entities: `SalesChartData`, `TopProducto`, `TopVendedor`, `TransaccionReciente`, `ProductoStockBajo`
  - Models: `VendedorMetricsModel`, `GerenteMetricsModel`, `AdminMetricsModel` (con `fromJson`/`toJson`)
  - Mapping snake_case ‚Üî camelCase

---

### 3. UX/UI (Design System)

- **[components_E003-HU-001.md](design/components_E003-HU-001.md)**
  - **Atoms**: `MetricCard`, `TrendIndicator`, `MetaProgressBar`
  - **Molecules**: `MetricsGrid`, `SalesLineChart`, `TopProductosList`, `TransaccionesRecientesList`
  - **Organisms**: `VendedorDashboard`, `GerenteDashboard`, `AdminDashboard`
  - **Pages**: `DashboardPage`
  - Responsive breakpoints (Mobile/Tablet/Desktop)
  - Loading skeletons y animaciones

---

### 4. Integraci√≥n Backend ‚Üî Frontend

- **[mapping_E003-HU-001.md](integration/mapping_E003-HU-001.md)**
  - Tabla completa de mapping (snake_case ‚Üî camelCase)
  - Ejemplos de Request/Response por endpoint
  - Manejo de errores (hints ‚Üí excepciones)
  - Implementaci√≥n completa de `DashboardRemoteDataSource`

---

## üéØ REGLAS DE NEGOCIO IMPLEMENTADAS

| C√≥digo | Descripci√≥n | Documento | Secci√≥n |
|--------|-------------|-----------|---------|
| **RN-001** | Segmentaci√≥n de dashboard por rol (Vendedor/Gerente/Admin) | [schema](backend/schema_E003-HU-001.md) | Funciones ¬ß3.1 |
| **RN-002** | C√°lculo de tendencias y comparativas (per√≠odo actual vs anterior) | [components](design/components_E003-HU-001.md) | TrendIndicator ¬ß1.2 |
| **RN-003** | Definici√≥n de stock bajo (< 5 unidades o < 10% stock_maximo) | [schema](backend/schema_E003-HU-001.md) | Tabla productos ¬ß1.2 |
| **RN-004** | Agregaci√≥n de m√©tricas en tiempo real | [apis](backend/apis_E003-HU-001.md) | get_dashboard_metrics ¬ß1.1 |
| **RN-005** | Top vendedores y productos m√°s vendidos | [apis](backend/apis_E003-HU-001.md) | get_top_productos ¬ß1.3 |
| **RN-006** | Acceso r√°pido desde cards de m√©tricas (navegaci√≥n con filtros) | [components](design/components_E003-HU-001.md) | MetricCard ¬ß1.1 |
| **RN-007** | Meta mensual y progreso (solo Gerente) | [models](frontend/models_E003-HU-001.md) | GerenteMetrics ¬ß1.3 |
| **RN-008** | Clientes activos del mes (con al menos 1 compra) | [schema](backend/schema_E003-HU-001.md) | Vistas ¬ß2.2, ¬ß2.3 |

---

## üìä ARQUITECTURA GENERAL

### Stack Tecnol√≥gico

- **Backend**: PostgreSQL (Supabase Local) + Vistas Materializadas
- **APIs**: PostgreSQL Functions (RPC) con formato JSON est√°ndar
- **Frontend**: Flutter Web + Clean Architecture + Bloc
- **UI**: Design System turquesa moderno (atoms/molecules/organisms)
- **Gr√°ficos**: `fl_chart` package

---

### Flujo de Datos

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 1. Usuario autenticado accede a /dashboard                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                          ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 2. DashboardBloc ejecuta GetDashboardMetrics UseCase          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                          ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 3. Repository llama a DashboardRemoteDataSource                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                          ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 4. Datasource ejecuta supabase.rpc('get_dashboard_metrics')   ‚îÇ
‚îÇ    Params: { p_user_id: userId }                               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                          ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 5. PostgreSQL Function detecta rol del usuario                ‚îÇ
‚îÇ    - Lee tabla `users` (rol)                                   ‚îÇ
‚îÇ    - Lee tabla `user_tiendas` (si Gerente)                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                          ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 6. PostgreSQL consulta vista materializada correspondiente    ‚îÇ
‚îÇ    - VENDEDOR ‚Üí dashboard_vendedor_metrics                     ‚îÇ
‚îÇ    - GERENTE ‚Üí dashboard_gerente_metrics                       ‚îÇ
‚îÇ    - ADMIN ‚Üí dashboard_admin_metrics                           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                          ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 7. Response JSON con estructura seg√∫n rol                     ‚îÇ
‚îÇ    { "success": true, "data": { "rol": "VENDEDOR", ... } }     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                          ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 8. Datasource mapea JSON ‚Üí Model (polimorfismo seg√∫n rol)     ‚îÇ
‚îÇ    VendedorMetricsModel / GerenteMetricsModel / AdminMetricsModel‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                          ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 9. Repository retorna Entity a UseCase ‚Üí Bloc                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                          ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 10. Bloc emite DashboardLoaded(metrics)                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                          ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 11. DashboardPage BlocBuilder selecciona Organism correcto    ‚îÇ
‚îÇ     - VendedorMetrics ‚Üí VendedorDashboard                      ‚îÇ
‚îÇ     - GerenteMetrics ‚Üí GerenteDashboard                        ‚îÇ
‚îÇ     - AdminMetrics ‚Üí AdminDashboard                            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                          ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 12. Organism renderiza MetricsGrid + Charts + Lists           ‚îÇ
‚îÇ     (Atoms: MetricCard, TrendIndicator)                        ‚îÇ
‚îÇ     (Molecules: SalesLineChart, TopProductosList)              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üóÇÔ∏è ESTRUCTURA DE CARPETAS

```
lib/
‚îú‚îÄ‚îÄ features/
‚îÇ   ‚îî‚îÄ‚îÄ dashboard/
‚îÇ       ‚îú‚îÄ‚îÄ data/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ datasources/
‚îÇ       ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ dashboard_remote_datasource.dart
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ models/
‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ vendedor_metrics_model.dart
‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ gerente_metrics_model.dart
‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ admin_metrics_model.dart
‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ sales_chart_data_model.dart
‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ top_producto_model.dart
‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ top_vendedor_model.dart
‚îÇ       ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ transaccion_reciente_model.dart
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ repositories/
‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ dashboard_repository_impl.dart
‚îÇ       ‚îú‚îÄ‚îÄ domain/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ entities/
‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ dashboard_metrics.dart
‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ vendedor_metrics.dart
‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ gerente_metrics.dart
‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ admin_metrics.dart
‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ sales_chart_data.dart
‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ top_producto.dart
‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ top_vendedor.dart
‚îÇ       ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ transaccion_reciente.dart
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ repositories/
‚îÇ       ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ dashboard_repository.dart
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ usecases/
‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ get_dashboard_metrics.dart
‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ get_sales_chart.dart
‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ get_top_productos.dart
‚îÇ       ‚îî‚îÄ‚îÄ presentation/
‚îÇ           ‚îú‚îÄ‚îÄ bloc/
‚îÇ           ‚îÇ   ‚îú‚îÄ‚îÄ dashboard_bloc.dart
‚îÇ           ‚îÇ   ‚îú‚îÄ‚îÄ dashboard_event.dart
‚îÇ           ‚îÇ   ‚îî‚îÄ‚îÄ dashboard_state.dart
‚îÇ           ‚îú‚îÄ‚îÄ pages/
‚îÇ           ‚îÇ   ‚îî‚îÄ‚îÄ dashboard_page.dart
‚îÇ           ‚îî‚îÄ‚îÄ widgets/
‚îÇ               ‚îú‚îÄ‚îÄ vendedor_dashboard.dart
‚îÇ               ‚îú‚îÄ‚îÄ gerente_dashboard.dart
‚îÇ               ‚îú‚îÄ‚îÄ admin_dashboard.dart
‚îÇ               ‚îú‚îÄ‚îÄ metrics_grid.dart
‚îÇ               ‚îú‚îÄ‚îÄ sales_line_chart.dart
‚îÇ               ‚îú‚îÄ‚îÄ top_productos_list.dart
‚îÇ               ‚îî‚îÄ‚îÄ transacciones_recientes_list.dart
‚îú‚îÄ‚îÄ shared/
‚îÇ   ‚îî‚îÄ‚îÄ design_system/
‚îÇ       ‚îú‚îÄ‚îÄ atoms/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ metric_card.dart
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ trend_indicator.dart
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ meta_progress_bar.dart
‚îÇ       ‚îî‚îÄ‚îÄ molecules/
‚îÇ           ‚îî‚îÄ‚îÄ (ya definidos en design/components)

supabase/
‚îî‚îÄ‚îÄ migrations/
    ‚îî‚îÄ‚îÄ YYYYMMDDHHMMSS_e003_hu001_dashboard_metrics.sql
```

---

## ‚úÖ CHECKLIST DE IMPLEMENTACI√ìN

### Backend (@supabase-expert)

- [ ] Crear migration con todas las tablas de negocio (tiendas, productos, clientes, ventas)
- [ ] Crear vistas materializadas (dashboard_vendedor_metrics, dashboard_gerente_metrics, dashboard_admin_metrics)
- [ ] Implementar funci√≥n `get_dashboard_metrics()`
- [ ] Implementar funci√≥n `get_sales_chart_data()`
- [ ] Implementar funci√≥n `get_top_productos()`
- [ ] Implementar funci√≥n `get_top_vendedores()`
- [ ] Implementar funci√≥n `get_productos_stock_bajo()`
- [ ] Implementar funci√≥n `refresh_dashboard_metrics()`
- [ ] Crear RLS policies por rol
- [ ] Poblar datos de prueba (seed)
- [ ] Tests de cada funci√≥n

---

### Frontend (@flutter-expert)

- [ ] Crear entities en `domain/entities/`
- [ ] Crear models en `data/models/` con `fromJson`/`toJson`
- [ ] Implementar `DashboardRemoteDataSource`
- [ ] Implementar `DashboardRepository`
- [ ] Implementar UseCases (GetDashboardMetrics, GetSalesChart, GetTopProductos)
- [ ] Implementar `DashboardBloc` con eventos y estados
- [ ] Tests unitarios de models (mapping)
- [ ] Tests unitarios de datasource
- [ ] Tests de repository
- [ ] Tests de usecases
- [ ] Tests de bloc

---

### UX/UI (@ux-ui-expert)

- [ ] Implementar atoms (MetricCard, TrendIndicator, MetaProgressBar)
- [ ] Implementar molecules (MetricsGrid, SalesLineChart, TopProductosList)
- [ ] Implementar organisms (VendedorDashboard, GerenteDashboard, AdminDashboard)
- [ ] Implementar `DashboardPage` con routing
- [ ] Implementar loading skeletons
- [ ] Implementar animaciones (hover, fade in, scale)
- [ ] Implementar responsive breakpoints (Mobile/Tablet/Desktop)
- [ ] Implementar navegaci√≥n desde cards (RN-006)
- [ ] Tests de widgets
- [ ] Validar Design System (theme-aware)

---

### QA (@qa-testing-expert)

- [ ] Tests de CA-001: Dashboard para Vendedor
- [ ] Tests de CA-002: Dashboard para Gerente
- [ ] Tests de CA-003: Dashboard para Admin
- [ ] Tests de CA-004: Actualizaci√≥n en tiempo real
- [ ] Tests de CA-005: Interactividad de m√©tricas (navegaci√≥n)
- [ ] Tests de CA-006: Visualizaci√≥n de tendencias
- [ ] Tests de integraci√≥n E2E (Backend + Frontend + UI)
- [ ] Tests de responsive (Mobile/Tablet/Desktop)
- [ ] Tests de performance (carga de m√©tricas < 2s)
- [ ] Validaci√≥n de RLS policies (seguridad por rol)

---

## üöÄ ORDEN DE IMPLEMENTACI√ìN

### Fase 1: Backend (Prioridad Alta)
1. Crear tablas de negocio base
2. Crear vistas materializadas
3. Implementar funci√≥n `get_dashboard_metrics()`
4. Poblar datos de prueba (seed)
5. Tests manuales en Supabase Studio

### Fase 2: Frontend Models (Prioridad Alta)
1. Crear entities polim√≥rficas
2. Crear models con mapping
3. Implementar datasource
4. Tests de mapping

### Fase 3: Frontend Business Logic (Prioridad Media)
1. Implementar repository
2. Implementar usecases
3. Implementar bloc
4. Tests de l√≥gica

### Fase 4: UI/UX (Prioridad Media)
1. Implementar atoms (MetricCard, TrendIndicator)
2. Implementar molecules (MetricsGrid, SalesLineChart)
3. Implementar organisms (Dashboards por rol)
4. Implementar DashboardPage

### Fase 5: Integraci√≥n y QA (Prioridad Alta)
1. Integraci√≥n completa Backend + Frontend + UI
2. Tests E2E
3. Validaci√≥n de todos los CA
4. Validaci√≥n de performance

---

## üìù NOTAS DE IMPLEMENTACI√ìN

### Optimizaciones

1. **Vistas Materializadas**: Refrescar cada 5 min (horario pico) o 30 min (valle)
2. **Cach√© Frontend**: Guardar m√©tricas por 2 min en memoria (evitar requests repetidos)
3. **Lazy Loading**: Cargar gr√°ficos solo cuando scroll llega a ellos
4. **Skeleton Screens**: Mostrar mientras carga (mejor UX que spinner)

---

### Consideraciones de Seguridad

- ‚úÖ Todas las funciones verifican que usuario est√© `APROBADO` y `email_verificado`
- ‚úÖ RLS policies filtran datos seg√∫n rol (VENDEDOR solo ve sus datos)
- ‚úÖ No exponer datos sensibles en responses (password_hash, tokens)
- ‚úÖ Validar par√°metros en backend (evitar SQL injection)

---

### Datos de Prueba (Seed)

Crear seed con:
- 3 tiendas activas
- 50 productos con stock variado (algunos en stock bajo)
- 100 clientes
- 500 ventas (√∫ltimos 6 meses)
- 5 vendedores, 2 gerentes, 1 admin

---

## üîó RELACIONES CON OTRAS HUs

- **Depende de**: E001-HU-001 (Login), E001-HU-002 (Confirmaci√≥n Email)
- **Bloquea**: E003-HU-002 (Navegaci√≥n y Men√∫s)
- **Relacionada**: Todas las HUs de ventas, inventario, clientes (proveen datos)

---

## üìö REFERENCIAS

- [00-CONVENTIONS.md](00-CONVENTIONS.md) - Convenciones t√©cnicas (FUENTE √öNICA DE VERDAD)
- [design/tokens.md](design/tokens.md) - Design System turquesa
- [Historia de Usuario Original](../historias-usuario/E003-HU-001-dashboard-metricas.md)

---

**Fecha de dise√±o**: 2025-10-06
**Arquitecto**: @web-architect-expert
**Estado**: üé® Arquitectura Completa - Listo para Implementaci√≥n
